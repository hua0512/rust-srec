name: rust-srec Release

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always
  CARGO_PROFILE_DEV_DEBUG: 0
  CARGO_PROFILE_TEST_DEBUG: 0
  CARGO_INCREMENTAL: 0

jobs:
  changes:
    name: Detect Desktop Changes
    runs-on: ubuntu-latest
    outputs:
      desktop_changed: ${{ steps.diff.outputs.desktop_changed }}
      base_tag: ${{ steps.diff.outputs.base_tag }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Detect changes since previous tag
        id: diff
        shell: bash
        run: |
          set -euo pipefail

          git fetch --tags --force

          CURRENT_TAG="${GITHUB_REF_NAME:-}"
          if [[ -z "$CURRENT_TAG" || "$CURRENT_TAG" == "" ]]; then
            # workflow_dispatch on a branch; compare against latest v* tag.
            CURRENT_TAG=""
          fi

          if [[ -n "${{ inputs.version || '' }}" ]]; then
            # Manual release path. We still diff against the latest v* tag.
            CURRENT_TAG=""
          fi

          BASE_TAG=""
          if [[ -n "$CURRENT_TAG" ]]; then
            BASE_TAG=$(git tag --list 'v*' --sort=-v:refname | grep -v "^${CURRENT_TAG}$" | head -n 1 || true)
          else
            BASE_TAG=$(git tag --list 'v*' --sort=-v:refname | head -n 1 || true)
          fi

          echo "base_tag=$BASE_TAG" >> "$GITHUB_OUTPUT"

          if [[ -z "$BASE_TAG" ]]; then
            # First release (or no tags). Always build desktop.
            echo "desktop_changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Diff base: $BASE_TAG"
          CHANGED=$(git diff --name-only "$BASE_TAG...HEAD")

          if echo "$CHANGED" | grep -Eq '^(rust-srec/src-tauri/|rust-srec/frontend/|rust-srec/src/|crates/|Cargo\.(toml|lock)$)'; then
            echo "desktop_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "desktop_changed=false" >> "$GITHUB_OUTPUT"
          fi

  check-and-test:
    name: Check and Test
    runs-on: ubuntu-latest
    env:
      RUSTC_WRAPPER: sccache
      SCCACHE_GHA_ENABLED: "true"
    steps:
      - uses: actions/checkout@v6
      - uses: mozilla-actions/sccache-action@v0.0.9
        with:
          version: "v0.13.0"
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: taiki-e/install-action@nextest
      - uses: ./.github/actions/setup-protoc
      - name: Install Linux desktop dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libglib2.0-dev libgtk-3-dev libsoup-3.0-dev librsvg2-dev libayatana-appindicator3-dev libxdo-dev libssl-dev
          sudo apt-get install -y libwebkit2gtk-4.1-dev || sudo apt-get install -y libwebkit2gtk-4.0-dev
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci
      - name: Check
        run: cargo check -p rust-srec --locked --all-features
      - name: Clippy
        run: cargo clippy -p rust-srec --locked --all-features -- -D warnings
      - name: Test
        run: cargo nextest run -p rust-srec --locked --all-features
      - name: Doctests
        run: cargo test -p rust-srec --locked --doc --all-features
      - name: sccache stats
        if: always()
        run: sccache --show-stats || true

  build:
    name: Build
    needs: check-and-test
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            artifact_name: rust-srec
            asset_name: rust-srec-linux-musl-amd64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: rust-srec
            asset_name: rust-srec-linux-amd64
          - os: ubuntu-22.04-arm
            target: aarch64-unknown-linux-musl
            artifact_name: rust-srec
            asset_name: rust-srec-linux-musl-arm64
          - os: ubuntu-22.04-arm
            target: aarch64-unknown-linux-gnu
            artifact_name: rust-srec
            asset_name: rust-srec-linux-arm64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: rust-srec.exe
            asset_name: rust-srec-windows-amd64.exe
          - os: macos-15-intel
            target: x86_64-apple-darwin
            artifact_name: rust-srec
            asset_name: rust-srec-macos-amd64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: rust-srec
            asset_name: rust-srec-macos-arm64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6
      - name: Enable sccache
        if: runner.os != 'macOS' || runner.arch == 'ARM64'
        shell: pwsh
        run: |
          "RUSTC_WRAPPER=sccache" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "SCCACHE_GHA_ENABLED=true" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      - uses: mozilla-actions/sccache-action@v0.0.9
        if: runner.os != 'macOS' || runner.arch == 'ARM64'
        with:
          version: "v0.13.0"
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: ./.github/actions/setup-protoc
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci
          key: ${{ matrix.target }}
      - name: Install build dependencies on Linux
        if: contains(matrix.os, 'ubuntu') && !contains(matrix.target, 'musl')
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config
      - name: Install musl-tools
        if: contains(matrix.target, 'musl')
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools musl-dev
      - name: Build
        if: "!contains(matrix.target, 'musl')"
        run: cargo build -p rust-srec --locked --release --target ${{ matrix.target }} --bins --features tls-native-fallback
      - name: Build (musl static)
        if: contains(matrix.target, 'musl')
        env:
          CC: musl-gcc
        run: cargo build -p rust-srec --locked --release --target ${{ matrix.target }} --features static-ssl --bins
      - name: Rename rust-srec-vapid binary
        shell: bash
        run: |
          VAPID_ASSET_NAME="${{ matrix.asset_name }}"
          VAPID_ASSET_NAME="${VAPID_ASSET_NAME/rust-srec-/rust-srec-vapid-}"
          echo "VAPID_ASSET_NAME=$VAPID_ASSET_NAME" >> "$GITHUB_ENV"
          if [[ "${{ matrix.os }}" == windows-* ]]; then
            cp "target/${{ matrix.target }}/release/rust-srec-vapid.exe" "$VAPID_ASSET_NAME"
          else
            cp "target/${{ matrix.target }}/release/rust-srec-vapid" "$VAPID_ASSET_NAME"
          fi
      - name: Rename binary
        shell: bash
        run: cp "target/${{ matrix.target }}/release/${{ matrix.artifact_name }}" "${{ matrix.asset_name }}"
      - name: Upload rust-srec-vapid binary
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.VAPID_ASSET_NAME }}
          path: ${{ env.VAPID_ASSET_NAME }}
          if-no-files-found: error
      - name: Upload binary
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.asset_name }}
          path: ${{ matrix.asset_name }}
          if-no-files-found: error
      - name: sccache stats
        if: always() && (runner.os != 'macOS' || runner.arch == 'ARM64')
        run: sccache --show-stats || true

  desktop:
    name: Desktop
    needs: [check-and-test, changes]
    if: needs.changes.outputs.desktop_changed == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            args: ''
          - os: ubuntu-22.04
            args: ''
          - os: macos-15-intel
            args: '--target x86_64-apple-darwin'
          - os: macos-latest
            args: '--target aarch64-apple-darwin'
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        working-directory: rust-srec/src-tauri
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ contains(matrix.args, '--target') && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - uses: ./.github/actions/setup-protoc

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci

      - name: Install dependencies (Linux only)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - uses: pnpm/action-setup@v4
        with:
          version: 10.28.1

      - uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: rust-srec/frontend/pnpm-lock.yaml

      - name: Install frontend dependencies
        run: pnpm -C ../../frontend install --frozen-lockfile

      - name: Build desktop bundles
        run: cargo tauri build --ci ${{ matrix.args }}

      - name: Upload bundles
        uses: actions/upload-artifact@v6
        with:
          name: rust-srec-desktop-${{ inputs.version && format('v{0}', inputs.version) || github.ref_name }}-${{ runner.os }}-${{ runner.arch }}
          path: rust-srec/src-tauri/target/release/bundle
          if-no-files-found: error

  docker-build:
    name: Build Docker
    needs: check-and-test
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-latest
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6
      - name: Prepare
        run: |
          platform=${{ matrix.platform }}
          echo "PLATFORM_PAIR=${platform//\//-}" >> $GITHUB_ENV
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push backend
        id: build-backend
        uses: docker/build-push-action@v6
        with:
          context: .
          file: rust-srec/Dockerfile
          platforms: ${{ matrix.platform }}
          outputs: type=image,name=ghcr.io/${{ github.repository_owner }}/rust-srec,push-by-digest=true,name-canonical=true,push=true
          cache-from: type=gha,scope=${{ env.PLATFORM_PAIR }}-backend
          cache-to: type=gha,mode=max,scope=${{ env.PLATFORM_PAIR }}-backend
      
      - name: Export digest backend
        run: |
          mkdir -p /tmp/digests/backend
          digest="${{ steps.build-backend.outputs.digest }}"
          touch "/tmp/digests/backend/${digest#sha256:}"
      
      - name: Build and push frontend
        id: build-frontend
        uses: docker/build-push-action@v6
        with:
          context: ./rust-srec/frontend
          file: rust-srec/frontend/Dockerfile
          platforms: ${{ matrix.platform }}
          outputs: type=image,name=ghcr.io/${{ github.repository_owner }}/rust-srec-frontend,push-by-digest=true,name-canonical=true,push=true
          cache-from: type=gha,scope=${{ env.PLATFORM_PAIR }}-frontend
          cache-to: type=gha,mode=max,scope=${{ env.PLATFORM_PAIR }}-frontend

      - name: Export digest frontend
        run: |
          mkdir -p /tmp/digests/frontend
          digest="${{ steps.build-frontend.outputs.digest }}"
          touch "/tmp/digests/frontend/${digest#sha256:}"

      - name: Upload digests
        uses: actions/upload-artifact@v6
        with:
          name: digests-${{ env.PLATFORM_PAIR }}
          path: /tmp/digests
          if-no-files-found: error
          retention-days: 1

  docker-merge:
    name: Merge Docker
    runs-on: ubuntu-latest
    needs: docker-build
    permissions:
      contents: read
      packages: write
    steps:
      - name: Download digests
        uses: actions/download-artifact@v7
        with:
          path: /tmp/digests
          pattern: digests-*
          merge-multiple: true
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Create manifest list and push backend
        working-directory: /tmp/digests/backend
        run: |
          docker buildx imagetools create \
            -t ghcr.io/${{ github.repository_owner }}/rust-srec:${{ steps.version.outputs.version }} \
            -t ghcr.io/${{ github.repository_owner }}/rust-srec:latest \
            $(printf 'ghcr.io/${{ github.repository_owner }}/rust-srec@sha256:%s ' *)
      
      - name: Create manifest list and push frontend
        working-directory: /tmp/digests/frontend
        run: |
          docker buildx imagetools create \
            -t ghcr.io/${{ github.repository_owner }}/rust-srec-frontend:${{ steps.version.outputs.version }} \
            -t ghcr.io/${{ github.repository_owner }}/rust-srec-frontend:latest \
            $(printf 'ghcr.io/${{ github.repository_owner }}/rust-srec-frontend@sha256:%s ' *)

  release:
    name: Release
    needs: [build, desktop, docker-merge]
    if: |
      always() &&
      needs.build.result == 'success' &&
      needs.docker-merge.result == 'success' &&
      (needs.desktop.result == 'success' || needs.desktop.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v7
        with:
          path: artifacts
          pattern: rust-srec-*
          merge-multiple: true
      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*
          generate_release_notes: true
