services:
  rust-srec:
    # NOTE: Images are tagged as vX.Y.Z (leading 'v'), e.g. VERSION=v0.1.0.
    image: ghcr.io/hua0512/rust-srec:${VERSION:-latest}
    container_name: rust-srec
    restart: unless-stopped
    ports:
      - "${API_PORT:-8080}:8080"
    volumes:
      - ${DATA_DIR:-./data}:/app/data
      - ${CONFIG_DIR:-./config}:/app/config
      - ${OUTPUT_DIR:-./output}:/app/output
      - ${LOG_DIR:-./logs}:/app/logs
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - DATABASE_URL=${DATABASE_URL:-sqlite:///app/data/rust-srec.db}
      - OUTPUT_DIR=/app/output
      - API_PORT=8080
      - API_BIND_ADDRESS=0.0.0.0
      # JWT Configuration
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET is required}
      - JWT_ISSUER=${JWT_ISSUER:-rust-srec}
      - JWT_AUDIENCE=${JWT_AUDIENCE:-rust-srec-api}
      # Token Expiration
      - ACCESS_TOKEN_EXPIRATION_SECS=${ACCESS_TOKEN_EXPIRATION_SECS:-3600}
      - REFRESH_TOKEN_EXPIRATION_SECS=${REFRESH_TOKEN_EXPIRATION_SECS:-604800}
      # Password Policy
      - MIN_PASSWORD_LENGTH=${MIN_PASSWORD_LENGTH:-8}
      # Browser Notifications (Web Push / VAPID)
      - WEB_PUSH_VAPID_PUBLIC_KEY=${WEB_PUSH_VAPID_PUBLIC_KEY:-}
      - WEB_PUSH_VAPID_PRIVATE_KEY=${WEB_PUSH_VAPID_PRIVATE_KEY:-}
      - WEB_PUSH_VAPID_SUBJECT=${WEB_PUSH_VAPID_SUBJECT:-}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "${CPU_LIMIT:-4}"
          memory: ${MEMORY_LIMIT:-4G}
        reservations:
          cpus: "${CPU_RESERVATION:-1}"
          memory: ${MEMORY_RESERVATION:-512M}
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  frontend:
    # NOTE: Images are tagged as vX.Y.Z (leading 'v'), e.g. VERSION=v0.1.0.
    image: ghcr.io/hua0512/rust-srec-frontend:${VERSION:-latest}
    container_name: rust-srec-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-80}:80"
    environment:
      - BACKEND_URL=${BACKEND_URL:-http://rust-srec:8080}
      # Session cookie configuration
      - SESSION_SECRET=${SESSION_SECRET:?SESSION_SECRET is required (min 32 chars)}
      # Cookie secure flag: 'true' = always, 'false' = never, omit for auto-detection via X-Forwarded-Proto
      - COOKIE_SECURE=${COOKIE_SECURE:-}
    depends_on:
      rust-srec:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

networks:
  default:
    name: rust-srec-network
